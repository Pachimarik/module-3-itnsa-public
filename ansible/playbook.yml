- hosts: 'all'
  gather_facts: 'no'
  become: 'yes'
  tasks:
############### INSTALL DOCKER AND MODULES #############################
    - name: "Install docker"
      yum:
        name:
          - docker
    
    - name: "Install docker-compose"
      get_url:
        url: https://github.com/docker/compose/releases/download/1.22.0/docker-compose-Linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: +x
  
    - name: "Enable docker"
      systemd:
        name: docker
        enabled: yes
        masked: no
    
    - name: "Start docker"
      systemd:
        state: started
        name: docker

    - name: "Install python-pip"
      yum:
        name:
          - python-pip

    - name: "Update pip"
      shell: python2.7 -m pip install --upgrade setuptools && python2.7 -m pip install --upgrade pip

    - name: "Install py module for docker"
      shell: python2.7 -m pip install docker==4.4.4 --ignore-installed && pip install docker-compose
################### INSTALL NGINX ######################################  
    - name: "Install nginx"
      shell: amazon-linux-extras install nginx1 -y

    - name: "Enable nginx"
      systemd:
        name: nginx
        enabled: yes
        masked: no
    
    - name: "Create folder for certs"
      file:
        path: /etc/nginx/private
        state: directory

    - name: "Copy config"
      copy:
        src: ../nginx/nginx.conf 
        dest: /etc/nginx/nginx.conf

################# APP ########################################

    - name: "Create folder for app"
      file:
        path: /app
        state: directory
    
    - name: "Move files for app"
      copy: src=../app/{{ item }} dest=/app/
      with_items:
      - .env
      - app.py
      - docker-compose.yml
      - Dockerfile
      - env.yml

    - name: "Run docker-compose"
      docker_compose:
        project_src: /app
        build: yes
      register: output

    